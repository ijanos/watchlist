---
import Layout from "../layouts/Layout.astro";
import watchlist from "../data/watchlist.json";

import Weekdays from "../components/stats/Weekdays.astro";
import Directors from "../components/stats/Directors.astro";
import Watchyears from "../components/stats/Watchyears.astro";
import Releaseyears from "../components/stats/Releaseyears.astro";
import HorizontalLine from "../components/HorizontalLine.astro";
import Days from "../components/stats/Days.astro";
import WeekdaysHours from "../components/stats/WeekdaysHours.astro";
import Weeks from "../components/stats/Weeks.astro";

const sumRuntimeMinutes = watchlist.reduce((acc, m) => acc + m.runtime, 0);
const hours = sumRuntimeMinutes / 60;
const days = Math.floor(hours / 24);

let directorCounter = new Map<string, number>();
watchlist
  .map((m) => m.director)
  .flat()
  .forEach((d) => {
    const n = directorCounter.has(d) ? directorCounter.get(d)! : 0;
    directorCounter.set(d, n + 1);
  });

function getLongestWeeklyStreak(dateStrings: string[]) {
  if (dateStrings.length === 0) return 0;

  // 1. Convert to Start of Week (Sunday) timestamps
  const weekTimestamps = dateStrings.map(d => {
    const date = new Date(d);
    const day = date.getDay(); // 0 for Sunday, 1 for Monday, etc.
    const diff = date.getDate() - day;
    const startOfWeek = new Date(date.setDate(diff));
    startOfWeek.setHours(0, 0, 0, 0); // Reset time to midnight
    return startOfWeek.getTime();
  });

  // 2. Remove duplicates and sort
  const uniqueWeeks = [...new Set(weekTimestamps)].sort((a, b) => a - b);
  let longestStreak = 0;
  let currentStreak = 1;
  const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;

  // 3. Loop through and check for 7-day gaps
  for (let i = 1; i < uniqueWeeks.length; i++) {
    if (uniqueWeeks[i] - uniqueWeeks[i - 1] === ONE_WEEK_MS) {
      currentStreak++;
    } else {
      longestStreak = Math.max(longestStreak, currentStreak);
      currentStreak = 1;
    }
  }

  return Math.max(longestStreak, currentStreak);
}

const watchdates = watchlist.filter((m) => m.watched).map((m) => m.watched) as string[];
const streak = getLongestWeeklyStreak(watchdates);

---

<Layout title="statistics | Janos' watchlist">
 <div class="bg-amber-50/75 rounded-lg backdrop-blur-md p-1 py-2 flex flex-col gap-2">
    <h1 class="text-5xl font-extrabold drop-shadow-xl pb-5">Statistics</h1>
    <p class="p-2">
      Welcome to my watchlist. I started tracking every movie I watched around
      2016. I try to include every movie I ever watched here so some dates,
      especially before 2016 maybe inaccurate. Movie lengths are sourced from
      the free OMDb database and may also be somewhat inaccurate.
    </p>
    <div class="flex flex-row flex-wrap gap-5 p-4 justify-around">
      <div class="flex flex-col items-center">
        <div class="text-4xl font-bold">{watchlist.length} films</div>
        <div>total watched</div>
      </div>
      <div class="flex flex-col items-center">
        <div class="text-4xl font-bold">{hours.toFixed(1)} hours</div>
        <div>of films watched</div>
        <div class="text-sm italic">
          {days} days, {Math.floor(hours) % 24} hours and {
            sumRuntimeMinutes % 60
          } minutes.
        </div>
      </div>
      <div class="flex flex-col items-center">
        <div class="text-4xl font-bold">{(directorCounter.size)}</div>
        <div>directors</div>
      </div>
      <div class="flex flex-col items-center">
        <div class="text-4xl font-bold">{streak}w</div>
        <div>longest streak</div>
      </div>
    </div>

    <HorizontalLine text="Years"/>

    <p>
    This chart shows how many movies I watched each year. I only started tracking what I watch around 2017, data before that is inaccurate.
    </p>

    <Watchyears/>

    <HorizontalLine text="Release years"/>

    <Releaseyears/>

    <HorizontalLine text="Weekdays"/>

    <Weekdays/>
    <WeekdaysHours/>

    <HorizontalLine text="Days"/>

    <Days/>

    <HorizontalLine text="Weeks"/>

    <Weeks/>

    <HorizontalLine text="Directors"/>

    <Directors/>

</Layout>
