---
import * as Plot from "@observablehq/plot";
import { JSDOM } from "jsdom";
import watchlist from "../data/watchlist.json";

let watchYearCounter = new Map<string, number>();
watchlist
  .filter((m) => m.watched)
  .map((m) => m.watched!.substring(0, 4)).forEach((year) => {
    const n = watchYearCounter.has(year) ? watchYearCounter.get(year)! : 0;
    watchYearCounter.set(year, n + 1);
  });

const plotdata = Array.from(watchYearCounter, ([key, value]) => ({ year: key, watches: value }));
const dom = new JSDOM("");

const plot = Plot.plot({
  document: dom.window.document,
  width: undefined,
  y: {
    grid: true,
    percent: false
  },
  x: {
    type: "band"
  },
  marks: [
    Plot.ruleY([0]),
    Plot.barY(plotdata, {x: "year", y: "watches", sort: {x: "x", reverse: false}, tip: true, fill: "steelblue"}),
    // Plot.tip(plotdata, Plot.pointerX({x: "Date", y: "Close"}))
  ]
})

const plotHTML = plot.outerHTML;
---

<div class="responsive-chart">
  <Fragment set:html={plotHTML} />
</div>

<style>
  .responsive-chart {
    width: 100%;
    /* 3. Give the container a max-width so it doesn't get absurdly huge */
    max-width: 900px;
    margin: auto;
  }

  /* 4. Force the SVG to respect the container width */
  .responsive-chart :global(svg) {
    width: 100% !important;
    height: auto !important;
  }

  /* 5. Target the SVG text directly for extra control if needed */
  .responsive-chart :global(text) {
    font-family: system-ui, sans-serif;
  }
</style>
